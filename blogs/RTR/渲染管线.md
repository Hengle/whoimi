# 渲染管线

最近回顾了一下基础的图形学内容，发现很多都忘记了，现在认真的总结一下。主要内容都来自[d3d的官方文档当中提取的图形管线](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/overviews-direct3d-11-graphics-pipeline)当中。

下图是一个总览的流程，这个流程主要是针对D3D API可配置的阶段：

![d3d11-pipeline-stages](img/renderpipeline-d3d11-pipeline-stages.jpg)

## 渲染管线总览

D3D 10和更高级的API支持将渲染管线 划分成不同的功能阶段，下面是每一个阶段的主要描述：

| Topic                              | Description                                                  |
| :--------------------------------- | :----------------------------------------------------------- |
| Input-Assembler Stage 输入装配阶段 | the first stage in the pipeline is the input-assembler (IA) stage.第一个阶段是输入装配阶段。 |
| Vertex Shader Stage                | The vertex-shader (VS) stage processes vertices from the input assembler, performing per-vertex operations such as transformations, skinning, morphing, and per-vertex lighting. （vertexShder阶段主要处理逐顶点操作，包括：transformation，顶点光照，变形，蒙皮等，他的数据来源于IA阶段。）Vertex shaders always operate on a single input vertex and produce a single output vertex（输入输出都是单独顶点）. |
| Tessellation Stages                | 曲面细分，处理的是表面：三角形。                             |
| Geometry Shader Stage              | 处理一系列顶点输入，产生一系列顶点输出。                     |
| Stream-Output Stage                | The purpose of the stream-output stage is to continuously output (or stream) vertex data from the geometry-shader stage (or the vertex-shader stage if the geometry-shader stage is inactive) to one or more buffers in memory (see [Getting Started with the Stream-Output Stage](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-output-stream-stage-getting-started)).  将顶点处理的数据传送到一个或者多个内存？ |
| Rasterizer Stage                   | The rasterization stage converts vector information (composed of shapes or primitives) into a raster image (composed of pixels) for the purpose of displaying real-time 3D graphics.  从顶点到图像。 |
| Pixel Shader Stage                 | The pixel-shader stage (PS) enables rich shading techniques such as per-pixel lighting and post-processing. **A pixel shader is a program that combines constant variables, texture data, interpolated per-vertex values, and other data to produce per-pixel outputs.** （pixel Shader主要将常量、纹理数据、逐顶点插值数据等内容来生成像素输出）The rasterizer stage invokes a pixel shader once for each pixel covered by a primitive, however, it is possible to specify a **NULL** shader to avoid running a shader. （光栅化阶段会为每一个被图元覆盖的像素执行一次pixelShader） |
| Output-Merger Stage                | The output-merger (OM) stage generates the final rendered pixel color using a combination of pipeline state（OM阶段会根据渲染状态的组合生成最终的颜色：pixel Shader输出，渲染目标，深度/stencil buffer内容）, the pixel data generated by the pixel shaders, the contents of the render targets, and the contents of the depth/stencil buffers. The OM stage is the final step for determining which pixels are visible (with depth-stencil testing) and blending the final pixel colors**.(OM阶段决定哪个像素可见，深度和stencil测试和blend。）** |



## 渲染阶段

### Input-Assembler Stage(IA) （未补全）

简介：IA阶段的目的主要是从user-filled buffer当中读取图元数据（points, lines and/or triangles），然后组合成在之后阶段需要使用的新的结构的图元数据。 AI阶段能够将顶点组合成不同的图元类型，组合过程需要读取相邻的数据，这部分数据只在Geometry Stage阶段可以。例如：如果一个几何着色器在三角形上被调用，那么他的输入就包括他自身的三个顶点，和相邻三角形的顶点数据。

#### IA阶段步骤总结

1. [Create Input Buffers](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-input-assembler-stage-getting-started#create-input-buffers)：使用输入的vertex data初始化input buffer。
2. [Create the Input-Layout Object](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-input-assembler-stage-getting-started#create-the-input-layout-object)：使用input layout object描述vertex buffer中的数据类型。
3. [Bind Objects to the Input-Assembler Stage](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-input-assembler-stage-getting-started#bind-objects-to-the-input-assembler-stage)：将vertex data buffer和layout object 绑定到IA阶段。
4. [Specify the Primitive Type](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-input-assembler-stage-getting-started#specify-the-primitive-type)：定义顶点数据如何组成图元。
5. [Call Draw Methods](https://docs.microsoft.com/en-us/windows/desktop/direct3d11/d3d10-graphics-programming-guide-input-assembler-stage-getting-started#call-draw-methods)：调用绘制方法，将绑定到IA的数据传送到pipeline。

#### Create Input Buffers

inpute buffer有两种：vertex buffer和index buffer。vertex buffer提供数据，index buffer提供数据索引，可以创建多个vertex buffer。可以创建一个index buffer。



### Vertex Shader Stage

vertex Shader的输入最多为16 个 32-bit的4维向量，输出也是一样。一个vertex shader必须至少有一个输入和一个输出（一个标量）。

vertex Shader能够处理两个来自IA阶段的系统生成值：VertexID and InstanceID，他们只提供给vertex shader stage。

vertex Shader在所有顶点上运行，包括有邻接拓扑关系的图元的相邻顶点。

顶点着色器可以在不需要屏幕空间导数的情况下执行加载和纹理采样操作。



### Tessellation Stages



### Geometry Shader Stage



### Stream-Output Stage



### Rasterizer Stage



### Output-Merger Stage

OM阶段的第一步就是Depth-Stencil Testing，























